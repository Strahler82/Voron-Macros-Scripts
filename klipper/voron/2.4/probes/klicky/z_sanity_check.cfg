[gcode_macro Z_SANITY_CHECK]
description: verify z offset value is sane
variable_skip: False
gcode:

  {% if skip %}
    M118 skipping Z_SANITY_CHECK
    SKIP_Z_SANITY_CHECK SKIP=False
  {% else %}

    {% set svv = printer.save_variables.variables %}
    {% set key = 'stored_last_z_offset' %}
    {% set stored = svv[key] | default(0.7) %}

    {% set offset = printer.gcode_move.homing_origin.z %}

    {% set min = stored - 0.1 %}
    {% set max = stored + 0.1 %}

    {% if offset > max or offset < min %}
      {% set msg = "z offset %0.2f out of bounds ((last: %0.2f min:%0.2f max:%0.2f) - aborting" % (offset, min, max) %}
      DOCK_PROBE
      NOTIFY MSG="{msg}"
      RAISE_ERROR MSG="{msg}"
    {% else %}
      M118 z offset { "%0.2f is sane (last: %0.2f min:%0.2f max:%0.2f)" % (stored, min, max) }
    {% endif %}

  {% endif %}


[gcode_macro SKIP_Z_SANITY_CHECK]
description: skip z sanity checks
gcode:
  {% set skip = params.SKIP|default(True, True)|int %}

  SET_GCODE_VARIABLE MACRO=Z_SANITY_CHECK VARIABLE=skip VALUE={skip}

  M118 { 'SKIP_Z_SANITY_CHECK = %d' % (skip) }
