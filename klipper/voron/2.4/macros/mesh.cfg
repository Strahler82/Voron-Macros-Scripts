[gcode_macro GENERATE_MESH]
variable_skip: False
gcode:
  {% set mesh = params.MESH | default('FULL') %}

  {% if skip %}
    {% if not printer['bed_mesh'].profile_name or 'xyz' not in printer.toolhead.homed_axes %}
      { action_respond_info('mesh skip criteria not met') }
      {% set skip = False %}
    {% else %}
      {% set mesh = 'SKIP' %}
    {% endif %}
  {% endif %}

  {% if 'SKIP' in mesh and skip %}
    { action_respond_info('skipping mesh generation') }
  {% else %}
    { action_respond_info('generating %s mesh' % (mesh)) }
    {% if 'FULL' in mesh %}
      FULL_BED_MESH
    {% elif 'FAST' in mesh %}
      FAST_BED_MESH
    {% elif 'EXTREME' in mesh %}
      EXTREME_BED_MESH
    {% else %}
      BED_MESH
    {% endif %}
  {% endif %}

  SKIP_MESH SKIP=False  # if you want to skip you need to explicity do it each time


[gcode_macro SKIP_MESH]
gcode:
  {% set skip = params.SKIP|default(True, True)|int %}

  SET_GCODE_VARIABLE MACRO=GENERATE_MESH VARIABLE=skip VALUE={skip}

  { action_respond_info('SKIP_MESH = %d' % (skip)) }
