[gcode_macro GENERATE_MESH]
description: use SKIP_MESH to decide whether to generate a mesh this run
variable_skip: False
gcode:
  {% set mesh = params.MESH | default('FULL') %}

  {% if skip %}
    {% if not printer['bed_mesh'].profile_name or 'xyz' not in printer.toolhead.homed_axes %}
      { action_respond_info('mesh skip criteria not met') }
      {% set skip = False %}
    {% else %}
      {% set mesh = 'SKIP' %}
    {% endif %}
  {% endif %}

  {% if 'SKIP' in mesh and skip %}
    { action_respond_info('skipping mesh generation') }
  {% else %}
    { action_respond_info('generating %s mesh' % (mesh)) }
    {% if 'FULL' in mesh %}
      FULL_BED_MESH
    {% elif 'FAST' in mesh %}
      FAST_BED_MESH
    {% elif 'EXTREME' in mesh %}
      EXTREME_BED_MESH
    {% else %}
      BED_MESH
    {% endif %}

    STATUS_MESH_END
  {% endif %}

  SKIP_MESH SKIP=False  # if you want to skip you need to explicity do it each time


[gcode_macro SKIP_MESH]
description: skip mesh on next run
gcode:
  {% set skip = params.SKIP|default(True, True)|int %}

  SET_GCODE_VARIABLE MACRO=GENERATE_MESH VARIABLE=skip VALUE={skip}

  { action_respond_info('SKIP_MESH = %d' % (skip)) }


[gcode_macro FULL_BED_MESH]
description: generate 7x7 mesh
gcode:
  MESH_PREP
  { action_respond_info("creating 7x7 bed mesh") }
  BED_MESH_CALIBRATE probe_count=7,7 relative_reference_index=24
  BRUSH_HOME


[gcode_macro FAST_BED_MESH]
description: generate 3x3 mesh with 1 sample
gcode:
  MESH_PREP
  { action_respond_info("creating 3x3 bed mesh") }
  BED_MESH_CALIBRATE probe_count=3,3 relative_reference_index=4 samples=1 mesh_pps=4,4
  BRUSH_HOME


[gcode_macro BED_MESH]
description: generate default mesh
gcode:
  MESH_PREP
  { action_respond_info("creating default (5x5) bed mesh") }
  BED_MESH_CALIBRATE
  BRUSH_HOME


[gcode_macro EXTREME_BED_MESH]
description: generate large, detailed mesh
gcode:
  MESH_PREP
  { action_respond_info("creating 9x9 bed mesh") }
  BED_MESH_CALIBRATE probe_count=9,9 relative_reference_index=40 mesh_min=15,25 mesh_max=335,320
  BRUSH_HOME


[gcode_macro MESH_PREP]
description: BED_MESH_CLEAR and QGL before each new mesh
gcode:
  STATUS_OFF
  BED_MESH_CLEAR
  QGL
  STATUS_MESH_START
