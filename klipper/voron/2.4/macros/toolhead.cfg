[gcode_macro HOME]
gcode:
  STATUS_HOME_START
  G28
  G90
  STATUS_HOME_END


[gcode_macro CHECK_HOMED]
description: home only if not already homed
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
    HOME
  {% endif %}


[gcode_macro PARK]
description: z hop safe distance and park toolhead at rear
gcode:
  {% set x = params.X|default(printer.toolhead.axis_maximum.x)|float %}
  {% set y = params.Y|default(printer.toolhead.axis_maximum.y)|float %}
  {% set x_park = x/2 %}
  {% set y_park = (y - 5.0)|abs %}
  { action_respond_info("parking to X:%f Y:%f" % (x_park, y_park)) }
  SAFE_Z
  G90
  G1 X{x_park} Y{y_park} F6000


[gcode_macro SAFE_Z]
description: z hop safe distance
variable_safe_z: 2
gcode:
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}

  {% set HOP = params.HOP|default(2)|float %}

  {% set z_safe = HOP %}

  {% if act_z < (max_z - HOP ) %}
      { action_respond_info("safe z-hop %f" % (z_safe)) }
  {% else %}
      {% set z_safe = max_z - act_z %}
      { action_respond_info("requested z-hop %f reduced to safe z-hop %f" % (HOP, z_safe)) }
  {% endif %}
  SET_GCODE_VARIABLE MACRO=SAFE_Z VARIABLE=safe_z VALUE={z_safe}
  G91
  G1 Z{z_safe} F900
  G90


[gcode_macro PARK_FRONT]
description: z hop safe distance and park toolhead at front
gcode:
  PARK Y=0


[gcode_macro BRUSH]
description: brush nozzle
gcode:
  {% set times = params.TIMES | default(3) | int %}
  {% set retract = params.RETRACT | default(False,True) | int %}

  CHECK_HOMED

  SAVE_GCODE_STATE NAME=__brush

  G90

  {% if retract %}
    {% if printer.extruder.temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
      M118 retracting filament before brush
      M83
      G1 E-7 F2400
    {% else %}
      retract = false
    {% endif %}
  {% endif %}

  G1 X76 Y345 Z5 F3000;

  {% for i in range(times) %}
    G1 X130 Y345 Z5 F3000;
    G1 X76 Y350 Z5 F3000;
    G1 X130 Y350 Z5 F3000;
    G1 X76 Y345 Z5 F3000;
  {% endfor %}

  {% if retract %}
    M83
    G1 E5 F300
  {% endif %}

  G1 X175 Y350 Z5 F3000

  RESTORE_GCODE_STATE NAME=__brush


[gcode_macro BRUSH_HOME]
description: brush nozzle before home
gcode:
  BRUSH
  G28


[gcode_macro CENTER]
description: center toolhead on bed
gcode:
  CHECK_HOMED
  G90
  G0 X175 Y175 Z30 F20000


[gcode_macro RAISE]
description: raise toolhead high and front, for working on gantry
gcode:
  CHECK_HOMED
  G90
  G0 X175 Y25 Z225 F20000


[gcode_macro ZUP]
gcode:
  {% if printer["gcode_macro AUTO_CALIBRATE_Z"] and printer["gcode_macro AUTO_CALIBRATE_Z"].skip %}
    M118 skipping ZUP
  {% else %}
    {% set steps = params.STEPS | default(1) | int %}
    {% set distance = 0.01 * steps %}
    SET_GCODE_OFFSET Z_ADJUST={distance} MOVE=1
    M118 z offset {"+%0.2f" % (distance)}
  {% endif %}


[gcode_macro ZDOWN]
gcode:
  {% if printer["gcode_macro AUTO_CALIBRATE_Z"] and printer["gcode_macro AUTO_CALIBRATE_Z"].skip %}
    M118 skipping ZDOWN
  {% else %}
    {% set steps = params.STEPS | default(1) | int %}
    {% set distance = 0.01 * steps %}
    SET_GCODE_OFFSET Z_ADJUST=-{distance} MOVE=1
    M118 z offset {"-%0.2f" % (distance)}
  {% endif %}
