[gcode_macro HOME]
gcode:
  STATUS_HOME_START
  G28
  G90
  STATUS_HOME_END


[gcode_macro CHECK_HOMED]
description: home only if not already homed (or home is forced)
variable_force: 0
gcode:
  {% set force = params.FORCE|default(printer['gcode_macro CHECK_HOMED']['force'],True) | int %}

  {% if "xyz" not in printer.toolhead.homed_axes or force %}
    HOME
    SET_GCODE_VARIABLE MACRO=CHECK_HOMED VARIABLE=force VALUE=0
  {% endif %}


[gcode_macro PARK]
description: z hop safe distance and park toolhead at rear
gcode:
  {% set x = params.X|default(printer.toolhead.axis_maximum.x)|float %}
  {% set y = params.Y|default(printer.toolhead.axis_maximum.y)|float %}
  {% set x_park = x/2 %}
  {% set y_park = (y - 5.0)|abs %}
  M118 { "parking to X:%0.1f Y:%0.1f" % (x_park, y_park) }
  SAFE_Z
  G90
  G1 X{x_park} Y{y_park} F6000
  DISPLAY_POSITION CLEAR=0


[gcode_macro SAFE_Z]
description: z hop safe distance
gcode:
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}

  {% set HOP = params.HOP|default(2)|float %}

  {% set z_safe = HOP %}

  M118 { "Z:%0.1f" % (act_z) }

  {% if act_z < (max_z - HOP ) %}
      M118 { "safe z-hop +%0.1f" % (z_safe) }
  {% else %}
      {% set z_safe = max_z - act_z %}
      M118 { "requested z-hop +%0.1f reduced to safe z-hop +%0.1f" % (HOP, z_safe) }
  {% endif %}

  G91
  G1 Z{z_safe} F900
  G90

  M114


[gcode_macro PARK_FRONT]
description: z hop safe distance and park toolhead at front
gcode:
  PARK Y=0


[gcode_macro BRUSH]
description: brush nozzle
gcode:
  {% set times = params.TIMES | default(3) | int %}
  {% set retract = params.RETRACT | default(False,True) | int %}

  CHECK_HOMED

  DOCK_PROBE

  M118 brushing...

  G90

  {% if retract %}
    {% if printer.extruder.temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
      M118 retracting filament before brush
      M83
      G1 E-2 F2400
    {% else %}
      M118 temperature too low - skipping retract
      {% set retract = false %}
    {% endif %}
  {% endif %}

  SAFE_Z HOP=10
  G1 X76 Y350 F9000;
  G1 Z5 F3000;

  {% for i in range(times) %}
    G1 X130 Y350 Z5 F3000;
    G1 X76 Y348 Z5 F3000;
    G1 X130 Y348 Z5 F3000;
    G1 X76 Y350 Z5 F3000;
  {% endfor %}

  {% if retract %}
    M83
    G1 E1 F300
    G4 P2000
  {% endif %}

  G1 X175 Y350 Z5 F3000


[gcode_macro BRUSH_HOME]
description: brush nozzle before home
gcode:
  BRUSH
  G28


[gcode_macro CENTER]
description: center toolhead on bed
gcode:
  CHECK_HOMED
  G90
  G0 X175 Y175 Z30 F20000


[gcode_macro RAISE]
description: raise toolhead high and front, for working on gantry
gcode:
  CHECK_HOMED
  G90
  G0 X175 Y25 Z225 F20000


[gcode_macro ZUP]
description: set z offset +0.01
gcode:
  {% if printer["gcode_macro AUTO_CALIBRATE_Z"] and printer["gcode_macro AUTO_CALIBRATE_Z"].skip %}
    M118 skipping ZUP
  {% else %}
    {% set steps = params.STEPS | default(1) | int %}
    {% set distance = 0.01 * steps %}
    SET_GCODE_OFFSET Z_ADJUST={distance} MOVE=1
    M118 z offset {"+%0.2f" % (distance)}
    STORE_Z_OFFSET
  {% endif %}


[gcode_macro ZDOWN]
description: set z offset -0.01
gcode:
  {% if printer["gcode_macro AUTO_CALIBRATE_Z"] and printer["gcode_macro AUTO_CALIBRATE_Z"].skip %}
    M118 skipping ZDOWN
  {% else %}
    {% set steps = params.STEPS | default(1) | int %}
    {% set distance = 0.01 * steps %}
    SET_GCODE_OFFSET Z_ADJUST=-{distance} MOVE=1
    M118 z offset {"-%0.2f" % (distance)}
    STORE_Z_OFFSET
  {% endif %}


[gcode_macro Z_OFFSET]
description: set z offset
gcode:
  {% set offset = params.OFFSET | float %}

  SET_GCODE_OFFSET Z=0.0
  SET_GCODE_OFFSET Z_ADJUST={offset}

  SKIP_AUTO_CALIBRATE_Z

  DISPLAY_Z


[gcode_macro DISPLAY_Z]
description: show z offset
gcode:
  {% set msg = "z offset: %0.2f" % (printer.gcode_move.homing_origin.z) %}
  M117 { msg }
