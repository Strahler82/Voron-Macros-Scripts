[gcode_macro TUNING_TOWER]
rename_existing: CORE_TUNING_TOWER
gcode:

  M118 overriding TUNING_TOWER...

  {% set command = params.COMMAND %}

  _RESET_TUNING_TOWER

  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=command VALUE='"{command}"'

  UPDATE_DELAYED_GCODE ID=_POLL_TUNING_TOWER DURATION=30

  CORE_TUNING_TOWER { rawparams } COMMAND=_TUNING_TOWER_CALLBACK


[gcode_macro _TUNING_TOWER_CALLBACK]
variable_command: "M118 ENOCOMMAND"
variable_start_temp: 0
variable_start_pa: 0
variable_start_smooth: 0
variable_start_scv: 0
variable_start_accel: 0
variable_end_temp: 0
variable_end_pa: 0
variable_end_smooth: 0
variable_end_scv: 0
variable_end_accel: 0
variable_step: 0
gcode:

  M118 TUNING_TOWER callback start

  {% set temp = printer.extruder.target %}
  {% set pa = printer.extruder.pressure_advance %}
  {% set smooth = printer.extruder.smooth_time %}
  {% set scv = printer.toolhead.square_corner_velocity %}
  {% set accel = printer.toolhead.max_accel %}

  {% set command = printer["gcode_macro _TUNING_TOWER_CALLBACK"].command | default("M118 ENOCOMMAND") %}

  { command } { rawparams }

  _TUNING_TOWER_STEP

  M118 TUNING_TOWER callback end


[gcode_macro _TUNING_TOWER_START]
gcode:
  {% set temp = printer.extruder.target %}
  {% set pa = printer.extruder.pressure_advance %}
  {% set smooth = printer.extruder.smooth_time %}
  {% set scv = printer.toolhead.square_corner_velocity %}
  {% set accel = printer.toolhead.max_accel %}

  {% set shaper = printer["gcode_macro RESTORE_INPUT_SHAPER"].shaper %}
  {% set z = "%0.2f" % (printer.toolhead.position.z | float) %}

  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_temp VALUE={temp}
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_pa VALUE={pa}
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_smooth VALUE={smooth}
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_scv VALUE={scv}
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_accel VALUE={accel}

  M118 TUNING_TOWER start settings: pa {pa}, smooth {smooth}, scv {scv}, accel {accel}, temp {temp}, shaper {shaper}


[gcode_macro _TUNING_TOWER_END]
gcode:
  {% set start_temp = printer["gcode_macro _TUNING_TOWER_CALLBACK"].start_temp %}
  {% set start_pa = printer["gcode_macro _TUNING_TOWER_CALLBACK"].start_pa %}
  {% set start_smooth = printer["gcode_macro _TUNING_TOWER_CALLBACK"].start_smooth %}
  {% set start_scv = printer["gcode_macro _TUNING_TOWER_CALLBACK"].start_scv %}
  {% set start_accel = printer["gcode_macro _TUNING_TOWER_CALLBACK"].start_accel %}

  {% set end_temp = printer["gcode_macro _TUNING_TOWER_CALLBACK"].end_temp %}
  {% set end_pa = printer["gcode_macro _TUNING_TOWER_CALLBACK"].end_pa %}
  {% set end_smooth = printer["gcode_macro _TUNING_TOWER_CALLBACK"].end_smooth %}
  {% set end_scv = printer["gcode_macro _TUNING_TOWER_CALLBACK"].end_scv %}
  {% set end_accel = printer["gcode_macro _TUNING_TOWER_CALLBACK"].end_accel %}

  {% set shaper = printer["gcode_macro RESTORE_INPUT_SHAPER"].shaper %}
  {% set z = "%0.2f" % (printer.toolhead.position.z | float) %}

  M118 TUNING_TOWER start settings: pa {start_pa}, smooth {start_smooth}, scv {start_scv}, accel {start_accel}, temp {start_temp}, shaper {shaper}
  M118 TUNING_TOWER   end settings: pa {end_pa}, smooth {end_smooth}, scv {end_scv}, accel {end_accel}, temp {end_temp}, shaper {shaper}, z{z}


[gcode_macro _TUNING_TOWER_STEP]
gcode:
  {% set temp = printer.extruder.target %}
  {% set pa = printer.extruder.pressure_advance %}
  {% set smooth = printer.extruder.smooth_time %}
  {% set scv = printer.toolhead.square_corner_velocity %}
  {% set accel = printer.toolhead.max_accel %}

  {% set step = printer["gcode_macro _TUNING_TOWER_CALLBACK"].step %}
  {% set z = "%0.2f" % (printer.toolhead.position.z | float) %}

  {% if step < 1 %}
    _TUNING_TOWER_START
    SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=step VALUE=1
  {% else %}
    SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=step VALUE={step+1}
    
    SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_temp VALUE={temp}
    SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_pa VALUE={pa}
    SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_smooth VALUE={smooth}
    SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_scv VALUE={scv}
    SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_accel VALUE={accel}

    M118 TUNING_TOWER step {step} settings: pa {pa}, smooth {smooth}, scv {scv}, accel {accel}, temp {temp}, z{z}
  {% endif %}


[delayed_gcode _POLL_TUNING_TOWER]
initial_duration: 0
gcode:
  {% if 'Printing' in printer.idle_timeout.state %}
    M118 still printing...
    UPDATE_DELAYED_GCODE ID=_POLL_TUNING_TOWER DURATION=60
  {% else %}
    M118 summarizing tuning tower...
    UPDATE_DELAYED_GCODE ID=_POLL_TUNING_TOWER DURATION=0
    _TUNING_TOWER_END
    _RESET_TUNING_TOWER
  {% endif %}
    

[gcode_macro _RESET_TUNING_TOWER]
gcode:
  UPDATE_DELAYED_GCODE ID=_POLL_TUNING_TOWER DURATION=0
  M118 resetting command...
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=command VALUE='"M118 ENOCOMMAND"'
  M118 resetting start...
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_temp VALUE=0
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_pa VALUE=0
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_smooth VALUE=0
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_scv VALUE=0
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=start_accel VALUE=0
  M118 resetting end...
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_temp VALUE=0
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_pa VALUE=0
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_smooth VALUE=0
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_scv VALUE=0
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=end_accel VALUE=0
  M118 resetting step...
  SET_GCODE_VARIABLE MACRO=_TUNING_TOWER_CALLBACK VARIABLE=step VALUE=0
  M118 done


