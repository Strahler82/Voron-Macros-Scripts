[gcode_macro FILAMENT_RUNOUT]
variable_skip_e_cooldown: False
description: filament runout event, skipping extruder cooldown if asked...
gcode:

  M118 filament runout triggered
  NOTIFY MSG="filament runout triggered"
  DISABLE_FILAMENT_SENSOR
  PAUSE

  {% if skip_e_cooldown %}
    {% set etemp =  printer['gcode_macro RESUME']['etemp']|default(0)|int %}

    {% if etemp > printer.configfile.settings.extruder.min_extrude_temp %}
      M118 maintaining extruder temperature at {etemp}
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET={etemp}
    {% else %}
      M118 no extruder temperature to restore...
    {% endif %}
  {% endif %}


[gcode_macro SKIP_EXTRUDER_COOLDOWN_ON_RUNOUT]
description: skip extruder cooldown on FILAMENT_RUNOUT
gcode:
  {% set skip = params.SKIP|default(True, True)|int %}

  SET_GCODE_VARIABLE MACRO=FILAMENT_RUNOUT VARIABLE=skip_e_cooldown VALUE={skip}

  M118 { 'SKIP_EXTRUDER_COOLDOWN_ON_RUNOUT = %d' % (skip) }


[gcode_macro ENABLE_FILAMENT_SENSOR]
description: enable filament runout sensor
variable_skip: False
gcode:
  {% if skip %}
    M118 skipping ENABLE_FILAMENT_SENSOR
  {% else %}
    M118 enabling filament sensor...
    SET_FILAMENT_SENSOR SENSOR=filament ENABLE=1
  {% endif %}

  FILAMENT_SENSOR_STATUS


[gcode_macro DISABLE_FILAMENT_SENSOR]
description: disable filament runout sensor
gcode:
  SET_FILAMENT_SENSOR SENSOR=filament ENABLE=0
  FILAMENT_SENSOR_STATUS


[gcode_macro FILAMENT_SENSOR_STATUS]
description: filament runout sensor status
gcode:
  {% set sensor = (printer['filament_switch_sensor filament'] or printer['filament_motion_sensor filament']) %}
  {% if sensor %}
    M118 { "filament sensor enabled: %s, filament: %s" % (sensor.enabled, sensor.filament_detected) }
  {% else %}
    M118 no filament sensor found
  {% endif %}


[gcode_macro SKIP_FILAMENT_SENSOR]
description: skip filament sensor enables for the duration of the print
gcode:
  {% set skip = params.SKIP|default(True, True)|int %}

  SET_GCODE_VARIABLE MACRO=ENABLE_FILAMENT_SENSOR VARIABLE=skip VALUE={skip}

  M118 { 'SKIP_FILAMENT_SENSOR = %d' % (skip) }


[gcode_macro FILAMENT_LOAD]
description: slow load 75mm of filament
gcode:
  SAVE_GCODE_STATE NAME=__filament__load
  M83
  G1 E45 F240
  G1 E30 F240
  RESTORE_GCODE_STATE NAME=__filament__load

[gcode_macro FILAMENT_UNLOAD]
description: fast unload 100mm of filament 
gcode:
  SAVE_GCODE_STATE NAME=__filament__load
  M83
  G1 E-45 F960
  G1 E-45 F960
  G1 E-10 F960
  RESTORE_GCODE_STATE NAME=__filament__load

[gcode_macro FILAMENT_PURGELOAD]
description: heat extruder to 225 then FILAMENT_LOAD
gcode:
  {% if printer[printer.toolhead.extruder].temperature <= 225 %}
    M109 S{225}
  {% endif %}

  FILAMENT_LOAD
