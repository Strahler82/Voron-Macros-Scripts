
[gcode_macro ERCF_ATTEMPT_RECOVER]
description: attempt to recover
gcode:
  {% set tool = params.TOOL | default(printer['gcode_macro CHANGE_TOOL'].tool, True) | int %}

  {% if printer["gcode_macro _ERCF_PAUSE"].is_paused %}
    M118 attempting recover...
    {% if printer.extruder.temperature < printer["gcode_macro _ERCF_VAR"].extruder_eject_temp %}
      M118 waiting for extruder to heat up...
      M109 S{printer["gcode_macro _ERCF_VAR"].extruder_eject_temp}
    {% endif %}
    M118 recovering T{tool}
    ERCF_GOTO_LOAD_POSITION
    ERCF_UNLOCK
    ERCF_EJECT
    _RECOVER_1 TOOL={tool}
    _RECOVER_2 TOOL={tool}
    _RECOVER_3 TOOL={tool}
    _RECOVER_4
  {% else %}
    M118 ercf not paused - no recover attempted
  {% endif %}

[gcode_macro _RECOVER_1]
gcode:
  {% if printer["gcode_macro _ERCF_PAUSE"].is_paused|int == 0 %}
    ERCF_HOME
  {% else %}
    M118 recover eject failed
  {% endif %}

[gcode_macro _RECOVER_2]
gcode:
  {% set tool = params.TOOL | int %}
  {% if printer["gcode_macro _ERCF_PAUSE"].is_paused|int == 0 %}
    T{tool}
  {% else %}
    M118 recover home failed
  {% endif %}

[gcode_macro _RECOVER_3]
gcode:
  {% if printer["gcode_macro _ERCF_PAUSE"].is_paused|int == 0 %}
    M118 recover successful - ok to RESUME
    _AUTO_RECOVER_UNLOCK
    RESUME
  {% else %}
    M118 recover load failed
  {% endif %}


[gcode_macro ERCF_AUTO_RECOVER]
description: autorecover
variable_lock: 0
gcode:

  {% if lock|int == 0) %}
    {% if printer["gcode_macro _ERCF_PAUSE"].is_paused %}
      _AUTO_RECOVER_LOCK
      ERCF_ATTEMPT_RECOVER
    {% endif %}
  {% else %}`
    M118 auto recover locked - skipping
  {% endif %}


[gcode_macro _AUTO_RECOVER_UNLOCK]
gcode:
  SET_GCODE_VARIABLE MACRO=ERCF_AUTO_RECOVER VARIABLE=lock VALUE=0
  M118 autorecover unlocked

[gcode_macro _AUTO_RECOVER_LOCK]
gcode:
  SET_GCODE_VARIABLE MACRO=ERCF_AUTO_RECOVER VARIABLE=lock VALUE=1
  M118 autorecover locked
