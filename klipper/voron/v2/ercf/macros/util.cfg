[gcode_macro ERCF_RECOVER]
description: attempt to recover
gcode:
  {% set tool = params.TOOL | default(printer["gcode_macro CHANGE_TOOL"].tool, True) %}

  {% if printer.extruder.temperature < printer["gcode_macro _ERCF_VAR"].extruder_eject_temp %}
    M118 waiting for extruder to heat up...
    M109 S{printer["gcode_macro _ERCF_VAR"].extruder_eject_temp}
  {% endif %}
  ERCF_GOTO_LOAD_POSITION
  ERCF_UNLOCK
  ERCF_EJECT
  _RECOVER_1 {rawparams}
  _RECOVER_2 {rawparams}
  _RECOVER_3 {rawparams}

[gcode_macro _RECOVER_1]
gcode:
  {% if printer["gcode_macro _ERCF_PAUSE"].is_paused|int == 0 %}
    ERCF_HOME
  {% else %}
    M118 recover eject failed
  {% endif %}

[gcode_macro _RECOVER_2]
gcode:
  {% set tool = params.TOOL | int %}
  {% if printer["gcode_macro _ERCF_PAUSE"].is_paused|int == 0 %}
    T{tool}
  {% else %}
    M118 recover home failed
  {% endif %}

[gcode_macro _RECOVER_3]
gcode:
  {% if printer["gcode_macro _ERCF_PAUSE"].is_paused|int == 0 %}
    M118 recover successful - ok to RESUME
  {% else %}
    M118 recover load failed
  {% endif %}

