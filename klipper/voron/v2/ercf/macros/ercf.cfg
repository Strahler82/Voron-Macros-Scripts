[include tool.cfg]
[include filament.cfg]
[include overrides.cfg]


[delayed_gcode INITIALIZE_ERCF]
initial_duration: 1
gcode:
  ERCF_HOME
  _ERCF_SELECT_TOOL TOOL=8
  _ERCF_SELECT_TOOL TOOL=0
  ERCF_HOME

  SET_FILAMENT_SENSOR SENSOR=filament ENABLE=0


[gcode_macro EXTRUDER_INIT]
description: select the starting ercf e
gcode:

  {% set tool = params.EXTRUDER | default(6, True) | int %}

  M118 ERCF: initializing tool {tool}

  RESTORE_CURRENT_NOZZLE

  NOTE_PRESSURE_ADVANCE

  SET_FILAMENT_SENSOR SENSOR=filament ENABLE=0

  SET_GCODE_VARIABLE MACRO=PURGE_LINE VARIABLE=passes VALUE=2

  SKIP_EXTRUDER_COOLDOWN_ON_PAUSE

  CHANGE_TOOL TO={tool} INIT=1

[gcode_macro EXTRUDER_CLEANUP]
description: retract filament, etc
gcode:
  ERCF_UNLOCK
  ERCF_EJECT
  ERCF_HOME
  RESTORE_PRESSURE_ADVANCE


[gcode_macro ERCF_RAISE_ERROR_IF_PAUSED]
description: abort if ercf is paused
gcode:
  {% set add = params.MSG | default("",True) %}

  {% if printer["gcode_macro _ERCF_PAUSE"].is_paused|int == 1 %}
    ERCF_UNLOCK
    {% set msg = "ERCF: raising error %s" % (add) %}
    M118 {msg}
    RAISE_ERROR MSG="{msg}"
  {% else %}
    M118 ercf not paused
  {% endif %}


[gcode_macro ERCF_UNFSCK]
description: unfsck stuff...
gcode:
  _ERCF_SERVO_UP
  _ERCF_MOTORS_OFF
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0


[gcode_macro ERCF_MAKE_FILAMENT_TIP]
gcode:
   _ERCF_FORM_TIP_STANDALONE FINAL_EJECT=1


[gcode_macro ERCF_TEST]
gcode:
  {% set tool = params.TOOL | default(8,True) | int %}
  M109 S245
  CENTER
  ERCF_HOME
  M118 testing toolhead T{tool}...
  T{tool}
  M83
  G92 E0
  G1 E20 F240
  ERCF_EJECT

[gcode_macro ERCF_TEST_ALL]
gcode:
  {% for i in range(9)|reverse %}
    ERCF_TEST TOOL={i}
  {% endfor %}
  BRUSH
  ERCF_HOME
  M118 ercf test complete

[gcode_macro ERCF_LOAD_ALL]
gcode:
  ERCF_HOME
  {% for i in range(9)|reverse %}
    _ERCF_SELECT_TOOL TOOL={i}
    ERCF_LOAD
    ERCF_EJECT
  {% endfor %}
  ERCF_HOME
  M118 ercf load test complete
