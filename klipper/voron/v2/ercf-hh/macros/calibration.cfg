[gcode_macro ER_CALIBRATE_TOOL]
gcode:
  {% set tool = params.TOOL | default(8,True) | int %}
  {% if tool == 0 %}
    M118 don't want to calibrate tool 0, right?
  {% else %}
    M118 calibrating tool T{tool}...
    M104 S245
    ERCF_HOME FORCE_UNLOAD=1 PRELOAD=0
    ER_RAISE_ERROR_IF_PAUSED
    CENTER
    ER_GOTO_LOAD_POSITION
    M109 S245
    ERCF_CALIBRATE_SINGLE TOOL={tool}
    ER_RAISE_ERROR_IF_PAUSED
    ERCF_HOME PRELOAD=0
    ER_RAISE_ERROR_IF_PAUSED
    ERCF_SELECT TOOL={tool}
    ER_RAISE_ERROR_IF_PAUSED
    ERCF_LOAD
    ER_RAISE_ERROR_IF_PAUSED
    ERCF_CALIBRATE_ENCODER RANGE=2 DIST=1000
    ER_RAISE_ERROR_IF_PAUSED
    ERCF_HOME PRELOAD=0
    ER_RAISE_ERROR_IF_PAUSED
    CENTER
    ER_GOTO_LOAD_POSITION
    T{tool}
    ER_RAISE_ERROR_IF_PAUSED
    ERCF_EJECT
    ER_RAISE_ERROR_IF_PAUSED
  {% endif %}


[gcode_macro ER_CALIBRATE_BLOCK]
gcode:
  {% set tool = params.TOOL | default(8,True) | int %}
  M118 calibrating block T{tool}...
  ERCF_HOME
  ERCF_SELECT TOOL=8
  ERCF_SELECT TOOL={tool}
  ERCF_LOAD
  ERCF_SERVO_UP
  ERCF_MOTORS_OFF
  SET_GCODE_VARIABLE MACRO=ER_CALIBRATE_BLOCK_END VARIABLE=tool VALUE={tool}
  M118 now run ER_CALIBRATE_BLOCK_END


[gcode_macro ER_CALIBRATE_BLOCK_END]
variable_tool: 8
gcode:
  {% set tool = params.TOOL | default(printer['gcode_macro ER_CALIBRATE_BLOCK_END']['tool']) | int %}
  ERCF_CALIBRATE_SELECTOR TOOL={tool}
  ERCF_HOME


[gcode_macro ER_CALIBRATE_ENCODER]
gcode:
  ERCF_HOME FORCE_UNLOAD=1 PRELOAD=1
  ERCF_CALIBRATE_ENCODER DIST=1000
  ERCF_EJECT
  ERCF_RESET
  ERCF_HOME


[gcode_macro ER_TEST_BUFFER]
gcode:
  {% set loops = params.LOOPS | default(0) | int %}
  {% set bowden = params.BOWDEN | default(1500) | int %}
  {% set extrude =  params.EXTRUDE | default(200) | int %}
  {% set times = params.TIMES | default(1) | int %}
  {% set tool = params.TOOL | default(0, True) | int %}
  {% set speed = params.SPEED | default(150) | int %}

  {% set loops_to_bowden = ({
    1: 300,
    2: 600,
    3: 900,
    4: 1200,
    5: 1500,
    6: 1800,
    7: 2100, 
    8: 2300
  }) %}

  ERCF_SELECT TOOL={tool}

  {% if loops %}
    {% set bowden = loops_to_bowden[loops] %}
  {% endif %}

  ERCF_TEST_LOAD LENGTH=50

  M118 {"starting test - iterations: %d, bowden: %d, extrude: %d" % (times, bowden, extrude) }

  {% for i in range(times) %}
    {% set e = extrude + (i*times) %}

    ERCF_TEST_MOVE_GEAR LENGTH={bowden} SPEED=150

    ERCF_TEST_MOVE_GEAR LENGTH={e} SPEED=10

    ERCF_TEST_MOVE_GEAR LENGTH=-{bowden} SPEED={speed}
  {% endfor %}

  M118 gather filament and eject when complete
