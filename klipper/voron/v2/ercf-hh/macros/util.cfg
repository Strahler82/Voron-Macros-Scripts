[gcode_macro ER_ATTEMPT_RECOVER]
description: attempt to recover
gcode:
  {% set tool = params.TOOL | default(printer['gcode_macro CHANGE_TOOL'].tool, True) | int %}

  {% if printer.ercf.is_paused %}
    {% if printer["gcode_macro _AUTO_RECOVER_LOCK"].lock|int == 0 %}
      M118 attempting recover...
      {% if printer.extruder.temperature < printer.ercf.min_temp_extruder %}
        M118 waiting for extruder to heat up...
        M109 S{printer.ercf.min_temp_extruder}
      {% endif %}
      M118 recovering T{tool}
      ER_GOTO_LOAD_POSITION
      ERCF_UNLOCK
      ERCF_EJECT
      _RECOVER_1 TOOL={tool}
      _RECOVER_2 TOOL={tool}
      _RECOVER_3 TOOL={tool}
    {% else %}
      M118 autorecover locked - no recover attempted
    {% endif %}
  {% else %}
    M118 ercf not paused - no recover attempted
  {% endif %}

[gcode_macro _RECOVER_1]
gcode:
  {% if printer.ercf.is_paused|int == 0 %}
    ERCF_HOME
  {% else %}
    M118 recover eject failed
  {% endif %}

[gcode_macro _RECOVER_2]
gcode:
  {% set tool = params.TOOL | int %}
  {% if printer.ercf.is_paused|int == 0 %}
    T{tool}
  {% else %}
    M118 recover home failed
  {% endif %}

[gcode_macro _RECOVER_3]
gcode:
  {% if printer.ercf.is_paused|int == 0 %}
    M118 recover successful - ok to RESUME
    RESUME
    _AUTO_RECOVER_UNLOCK
  {% else %}
    M118 recover load failed
  {% endif %}


[delayed_gcode ER_AUTO_RECOVER]
initial_duration: 0
gcode:

  {% if printer.ercf.is_paused %}
    {% if printer["gcode_macro _AUTO_RECOVER_LOCK"].lock|int == 0 %}
      _AUTO_RECOVER_LOCK
      ER_ATTEMPT_RECOVER
    {% else %}
      M118 locked - skipping autorecover attempt
    {% endif %}
  {% endif %}

  UPDATE_DELAYED_GCODE ID=ER_AUTO_RECOVER DURATION={printer["gcode_macro ER_AUTO_RECOVER_ON"].duration}


[gcode_macro _AUTO_RECOVER_UNLOCK]
gcode:
  SET_GCODE_VARIABLE MACRO=_AUTO_RECOVER_LOCK VARIABLE=lock VALUE=0
  M118 autorecover unlocked

[gcode_macro _AUTO_RECOVER_LOCK]
variable_lock: 1
gcode:
  SET_GCODE_VARIABLE MACRO=_AUTO_RECOVER_LOCK VARIABLE=lock VALUE=1
  M118 autorecover locked


[gcode_macro ER_AUTO_RECOVER_ON]
variable_duration: 60
gcode:
  _AUTO_RECOVER_UNLOCK
  UPDATE_DELAYED_GCODE ID=ER_AUTO_RECOVER DURATION={duration}
  M118 autorecover on

[gcode_macro ER_AUTO_RECOVER_OFF]
gcode:
  _AUTO_RECOVER_LOCK
  UPDATE_DELAYED_GCODE ID=ER_AUTO_RECOVER DURATION=0
  M118 autorecover off
